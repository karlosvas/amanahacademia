---
import "@/styles/global.css";
import SEO from "@/components/layout/SEO/SEO.astro";
import { Toaster } from "solid-toast";
import type { PropsSEO } from "@/types/types";
import AdministratorPanel from "@/components/dashboard/AdministratorPanel.astro";
import { cookiesTranslation } from "@/../i18n/index";
import { Languages } from "@/enums/enums";
import ArrowIcon from "@/assets/arrow.svg";

// Obtener el idioma de la cookie o usar español por defecto
const langCookies = Astro.cookies.get("langCookie")?.value || Languages.SPANISH;

// Solo establecer la cookie si no existe (evitar establecerla en cada request)
if (!Astro.cookies.get("langCookie")) {
  Astro.cookies.set("langCookie", Languages.SPANISH, {
    path: "/",
    maxAge: 60 * 60 * 24 * 365,
    sameSite: "lax",
    httpOnly: false,
  });
}

const {
  lang = "es",
  title = "Amanah Academia - Aprende idiomas online",
  description = "Academia online de árabe y español con profesores nativos. Clases personalizadas, cursos estructurados y recursos didácticos. Prueba gratis.",
  canonical,
  ogImage,
  noindex,
  keywords,
  structuredDataType,
  structuredData,
} = Astro.props as PropsSEO;

const theme = Astro.cookies.get("theme")?.value;
const cookieMessage =
  cookiesTranslation[lang as keyof typeof cookiesTranslation]?.message || cookiesTranslation["es"].message;
---

<!doctype html>
<html lang={langCookies} class={`m-0 w-full h-full ${theme ? ` ${theme}` : ""}`}>
  <head>
    <!-- Codificacion -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    <!-- Políticas de seguridad -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none" />
    <meta
      http-equiv="Content-Security-Policy"
      content="
    default-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' 'unsafe-eval'
      https://www.gstatic.com
      https://apis.google.com
      https://accounts.google.com
      https://www.googleapis.com
      https://www.googletagmanager.com
      https://www.google-analytics.com
      https://cdnjs.cloudflare.com
      https://challenges.cloudflare.com
      https://unpkg.com
      https://js.stripe.com
      *;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com
      https://fonts.cdnfonts.com
      https://cdnjs.cloudflare.com
      *;
    font-src 'self'
      https://fonts.gstatic.com
      https://fonts.cdnfonts.com
      https://cdnjs.cloudflare.com
      *;
    connect-src 'self'
      https://identitytoolkit.googleapis.com
      https://securetoken.googleapis.com
      https://accounts.google.com
      https://www.google-analytics.com
      https://analytics.google.com
      https://region1.google-analytics.com
      https://www.googletagmanager.com
      https://stats.g.doubleclick.net
      https://challenges.cloudflare.com
      https://amanahacademia.fly.dev
      https://api.stripe.com
      https://api.cal.com
      https://cal.com
      https://pub-acdd170e6c22482caeec0e876c5d4178.r2.dev
      https://assets.amanahacademia.com
      http://localhost:3000
      ws://localhost:*
      *;
    frame-src
      https://js.stripe.com
      https://hooks.stripe.com
      https://cal.com
      https://app.cal.com
      *;
    img-src * data: blob:;
    object-src 'none';
    base-uri 'self';
    form-action 'self' https://api.stripe.com;
  "
    />
    <!-- Preloads -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://challenges.cloudflare.com" />
    <link rel="dns-prefetch" href="https://apis.google.com" />

    <!-- Favicon clásico para compatibilidad total -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <!-- Favicon SVG (para navegadores que lo soporten) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <!-- PNG de fallback -->
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png" />
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" sizes="180x180" />
    <!-- Manifest PWA -->
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <!-- Sitemap -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    <!-- SEO Components -->
    <SEO
      title={title}
      description={description}
      canonical={canonical}
      ogImage={ogImage}
      noindex={noindex}
      keywords={keywords}
      structuredDataType={structuredDataType}
      structuredData={structuredData}
    />
    <!-- Google tag (gtag.js) -->
    <script is:inline>
      const GA_ID = "G-CW35G9DQ63";

      // Inicializar dataLayer
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      window.gtag = gtag;

      // Debug mode
      const isDebug =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1" ||
        new URLSearchParams(window.location.search).get("ga_debug") === "1";

      // Consentimiento por defecto
      gtag("consent", "default", {
        ad_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied",
        analytics_storage: "denied",
      });

      // Configurar GA4
      gtag("js", new Date());
      gtag("config", GA_ID, {
        debug_mode: isDebug,
        send_page_view: false,
      });

      // Cargar el script de gtag.js
      const script = document.createElement("script");
      script.async = true;
      script.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_ID;
      document.head.appendChild(script);
    </script>
    <!-- Inicialización de cookies (tema e idioma) -->
    <script>
      import { Languages } from "@/enums/enums";
      import { getThemeFromCookie, writeThemeCookie, getLangFromCookie, writeLangCookie } from "@/utils/cookie";
      import { applyThemeClass } from "@/utils/theme";

      const initTheme = () => {
        const cookieTheme = getThemeFromCookie();
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = cookieTheme ?? (prefersDark ? "dark" : "light");

        applyThemeClass(theme);
        if (!cookieTheme) writeThemeCookie(theme);

        window.setTheme = (value) => {
          if (value === "dark" || value === "light") {
            applyThemeClass(value);
            writeThemeCookie(value);
          } else {
            console.warn(`Valor de tema no válido: ${value}`);
          }
        };
      };

      const initLang = () => {
        const currentLang = getLangFromCookie();
        const validLangs = ["ar", "de", "en", "es", "fr", "it", "pt"];

        // Si la cookie tiene un valor inválido (como favicon.ico), limpiarla
        if (!validLangs.includes(currentLang)) {
          console.warn(`[Lang Init] Cookie con valor inválido detectada: ${currentLang}. Limpiando...`);
          writeLangCookie(Languages.SPANISH); // Establecer español por defecto
        }
      };

      window.addEventListener("DOMContentLoaded", () => {
        initTheme();
        initLang();
      });
    </script>
  </head>
  <body class="m-0 w-full h-full bg-background">
    <slot />
    <Toaster
      client:load
      position="bottom-right"
      gutter={64}
      toastOptions={{
        duration: 5000,
      }}
    />
    <!-- Banner de cookies profesional -->
    <aside
      id="cookie-banner"
      class="fixed bottom-0 left-0 right-0 bg-smoothBrown border-t-2 border-lightBrown shadow-lg z-[1000] hidden animate-slide-up"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
          <!-- Contenido del mensaje -->
          <div class="flex items-center gap-3 flex-1">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-lightBrown flex-shrink-0 mt-0.5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="py-5 md:py-0">
              <p class="text-sm text-black font-semibold text-center pb-5 md:pb-0">{cookieMessage[0]}</p>
              <p class="text-xs text-black opacity-80 mt-1 flex sm:flex-col">
                <span>{cookieMessage[1]}</span>
                <a
                  href="/legal"
                  title={cookieMessage[2]}
                  rel="license"
                  aria-label={cookieMessage[2]}
                  class="text-lightRed hover:text-salmon font-semibold underline decoration-lightRed/30 hover:decoration-salmon/50 transition-colors"
                >
                  {cookieMessage[2]}
                </a>
              </p>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="flex gap-3 flex-shrink-0">
            <button
              id="rejectCookies"
              class="px-5 py-2.5 text-sm font-semibold text-black border-2 border-lightBrown rounded-lg hover:bg-brown hover:text-white hover:border-brown transition-all duration-200 shadow-sm"
            >
              {cookiesTranslation[lang as keyof typeof cookiesTranslation]?.reject || cookiesTranslation["es"].reject}
            </button>
            <button
              id="acceptCookies"
              class="px-5 py-2.5 text-sm font-semibold text-white bg-lightRed hover:bg-salmon rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
            >
              {cookiesTranslation[lang as keyof typeof cookiesTranslation]?.accept || cookiesTranslation["es"].accept}
            </button>
          </div>
        </div>
      </div>
    </aside>
    <div
      id="backToTop"
      class="fixed bottom-24 right-8 w-14 h-14 bg-salmon hover:bg-lightSalmon text-white flex items-center justify-center cursor-pointer z-[9999] bg-gradient-to-br from-lightRed to-salmon rounded-full shadow-lg hover:shadow-2xl transition-all duration-300 opacity-0 invisible"
      onclick="window.scrollTo({top:0, behavior:'smooth'})"
    >
      <ArrowIcon height={25} />
    </div>
    <AdministratorPanel />
  </body>
</html>

<script>
  import { closeModalsEvents } from "@/utils/modals";
  import { acceptCookies, rejectCookies, initializeCookieConsent } from "@/utils/cookie";
  import { onAuthStateChanged } from "@/services/firebase";
  import { syncTokenWithServer, syncLogoutWithServer } from "@/utils/auth";
  import type { User } from "firebase/auth";

  let tokenRefreshInterval: ReturnType<typeof setInterval> | null = null;

  // Inicializar Firebase Auth y listener de cambios de usuario
  onAuthStateChanged(async (user: User | null) => {
    // Limpiar interval previo si existe
    if (tokenRefreshInterval) {
      clearInterval(tokenRefreshInterval);
      tokenRefreshInterval = null;
    }

    if (user) {
      await syncTokenWithServer(); // Sync inicial
      tokenRefreshInterval = setInterval(
        async () => {
          await syncTokenWithServer();
        },
        50 * 60 * 1000
      );
    } else await syncLogoutWithServer();
  });

  // Eventos para poder cerrar con animacion caulquier modal
  closeModalsEvents();
  // Inicializar consentimiento al cargar
  initializeCookieConsent();

  // Aceptar las cookies
  const acceptCookiesElement = document.getElementById("acceptCookies");
  if (acceptCookiesElement) {
    acceptCookiesElement.addEventListener("click", () => acceptCookies());
  }

  // Rechazar las cookies
  const rejectCookiesElement = document.getElementById("rejectCookies");
  if (rejectCookiesElement) {
    rejectCookiesElement.addEventListener("click", () => rejectCookies());
  }

  // Botón para volver al inicio - usando MutationObserver para detectar cambios de scroll
  const backToTopButton = document.getElementById("backToTop");

  if (backToTopButton) {
    let lastKnownScrollPosition = 0;

    const updateButtonVisibility = () => {
      // Intentar obtener scroll de múltiples fuentes
      const scrolled =
        window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || window.scrollY || 0;

      // Solo actualizar si cambió
      if (scrolled !== lastKnownScrollPosition) {
        lastKnownScrollPosition = scrolled;

        if (scrolled > 200) {
          backToTopButton.style.opacity = "1";
          backToTopButton.style.visibility = "visible";
        } else {
          backToTopButton.style.opacity = "0";
          backToTopButton.style.visibility = "hidden";
        }
      }
    };

    // Polling cada 100ms para capturar el scroll
    setInterval(updateButtonVisibility, 100);

    // Estado inicial
    updateButtonVisibility();

    // Click handler
    backToTopButton.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
      // También intentar scroll en body y html
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    });
  }

  // Animacion de fade-in al hacer scroll
  const elements = document.querySelectorAll(".scroll-fade-in");
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) entry.target.classList.add("visible");
      });
    },
    {
      threshold: 0.1,
      rootMargin: "-50px 0px -50px 0px",
    }
  );

  elements.forEach((el) => observer.observe(el));
</script>

<style>
  @keyframes slide-up {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .animate-slide-up {
    animation: slide-up 0.3s ease-out;
  }

  @keyframes slide-down {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100%);
      opacity: 0;
    }
  }
  @keyframes pulse {
    0%,
    100% {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
    }
    50% {
      box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
  }

  /* Hover: efecto pulse + ligera escala */
  #backToTop:hover {
    transform: scale(1.08);
    animation: pulse 2s infinite;
  }

  /* Transición suave en el contenido interno (estado normal) */
  #backToTop > svg,
  #backToTop > * {
    transform: rotate(0deg);
    transition: transform 0.3s ease;
  }

  /* Rotación del contenido interno al hacer hover */
  #backToTop:hover > svg,
  #backToTop:hover > * {
    transform: rotate(180deg);
  }

  /* Ajustes responsivos / accesibles */
  @media (prefers-reduced-motion: reduce) {
    #backToTop,
    #backToTop:hover {
      animation: none !important;
      transition: none !important;
    }
  }
</style>
