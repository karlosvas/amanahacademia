---
import { getSEOData } from "i18n/seo";
import { DashboardAdminTypes, type PropsSEO } from "@/types/types";
import { parseUsersMetricData } from "@/utils/metrics";
import { ApiService } from "@/services/helper";
import PanelDashboard from "@/components/dashboard/panel/PanelDashboard.astro";
import PanelClasses from "@/components/dashboard/panel/PanelClasses.astro";
import Layout from "@/layouts/Layout.astro";
import { log } from "@/services/logger";
import PanelUser from "@/components/dashboard/panel/PanelUser.astro";
import PanelPayments from "@/components/dashboard/panel/PanelPayments.astro";
import PanelContent from "@/components/dashboard/panel/PanelContent.astro";
import type { ResponseAPI } from "@/types/bakend-types";

const helper = new ApiService();
const token = Astro.cookies.get("session")?.value ?? "";

if (!token) {
  log.error("Deves logearte previamente");
  return Astro.redirect("/");
}
const isAdmin: ResponseAPI<boolean> = await helper.isAdminUser(token);

if (!isAdmin.success || !isAdmin.data) return Astro.redirect("/");

const currentLang = "es";
const seoData = getSEOData("panel-admin", currentLang) as PropsSEO;

const url = new URL(Astro.request.url);
let section = url.searchParams.get("section");

// Verificar si section es uno de los valores válidos del enum
const validSections = Object.values(DashboardAdminTypes);
if (!section || !validSections.includes(section as DashboardAdminTypes)) return Astro.redirect("/");

// Obtenemos las metricasmos las metricas necesarias
const metrics = await helper.getUserMetrics(token);
let stats = {
  totalUsers: 0,
  activeUsers: 0,
  newUsers: 0,
  conversionRate: 0,
  changes: {
    totalUsers: "+0%",
    activeUsers: "+0%",
    newUsers: "+0%",
    conversionRate: "+0%",
  },
};

if (metrics.success && metrics.data.rows.length > 0) {
  const parsed = metrics.data.rows.map(parseUsersMetricData);

  const latest = parsed[parsed.length - 1];
  const previous = parsed.length > 1 ? parsed[parsed.length - 2] : null;

  stats.totalUsers = latest.totalUsers;
  stats.activeUsers = latest.activeUsers;
  stats.newUsers = latest.newUsers;

  const convRate = (latest.engagedSessions / latest.sessions) * 100;
  stats.conversionRate = convRate;

  // Calcular cambios vs mes anterior
  if (previous) {
    if (previous.totalUsers > 0) {
      const totalChange = ((latest.totalUsers - previous.totalUsers) / previous.totalUsers) * 100;
      stats.changes.totalUsers = `${totalChange > 0 ? "+" : ""}${totalChange.toFixed(1)}%`;
    } else {
      stats.changes.totalUsers = `+${latest.totalUsers}`;
    }

    if (previous.activeUsers > 0) {
      const activeChange = ((latest.activeUsers - previous.activeUsers) / previous.activeUsers) * 100;
      stats.changes.activeUsers = `${activeChange > 0 ? "+" : ""}${activeChange.toFixed(1)}%`;
    } else {
      stats.changes.activeUsers = `+${latest.activeUsers}`;
    }

    if (previous.newUsers > 0) {
      const newChange = ((latest.newUsers - previous.newUsers) / previous.newUsers) * 100;
      stats.changes.newUsers = `${newChange > 0 ? "+" : ""}${newChange.toFixed(1)}%`;
    } else {
      stats.changes.newUsers = `+${latest.newUsers}`;
    }

    const prevRate = (previous.engagedSessions / previous.sessions) * 100;
    const convChange = convRate - prevRate;
    stats.changes.conversionRate = `${convChange > 0 ? "+" : ""}${convChange.toFixed(1)}%`;
  } else {
    stats.changes.totalUsers = `+${latest.totalUsers}`;
    stats.changes.activeUsers = `+${latest.activeUsers}`;
    stats.changes.newUsers = `+${latest.newUsers}`;
    stats.changes.conversionRate = `${convRate.toFixed(1)}%`;
  }
}
---

<Layout
  lang={currentLang}
  title={seoData.title}
  description={seoData.description}
  canonical={seoData.canonical}
  ogImage={seoData.ogImage}
  noindex={seoData.noindex}
  keywords={seoData.keywords}
  structuredDataType={seoData.structuredDataType}
  structuredData={seoData.structuredData}
>
  <div class="min-h-screen lg:px-72 bg-gradient-to-br from-[#fff4e1] to-[#fee8d6] p-6">
    <div class="max-w-7xl mx-auto">
      {
        section === DashboardAdminTypes.DASHBOARD ? (
          <PanelDashboard stats={stats} />
        ) : section === DashboardAdminTypes.CLASSES ? (
          <PanelClasses stats={stats} />
        ) : section === DashboardAdminTypes.USERS ? (
          <PanelUser />
        ) : section === DashboardAdminTypes.PAYMENTS ? (
          <PanelPayments />
        ) : section === DashboardAdminTypes.CONTENT ? (
          <PanelContent stats={stats} />
        ) : null
      }
    </div>

    <!-- Botón de volver mejorado -->
    <div class="max-w-7xl mx-auto mt-8 flex justify-end">
      <a
        href={`/${Astro.cookies.get("langCookie")?.value}`}
        class="inline-flex items-center gap-2 px-6 py-3 bg-[#8a4141] text-white font-semibold rounded-lg hover:bg-[#6d3333] transition-all duration-300 shadow-md hover:shadow-lg hover:-translate-y-0.5"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd"></path>
        </svg>
        Volver al inicio
      </a>
    </div>
  </div>
</Layout>
