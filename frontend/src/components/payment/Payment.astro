---
import Title from "../common/Title.astro";
---

<div id="app-config" class="container h-screen">
  <div class="card">
    <Title sizeText="text-lg" sizeLine="h-1" sizeWidth="w-20">
      Finaliza tu inscripción<span class="ml-2" id="pricing"></span>
    </Title>

    <!-- Mensajes de estado -->
    <div id="error-message" class="message error-message"></div>

    <!-- Contenedor para los elementos de pago -->
    <div id="payment-element-container">
      <div class="loading">Inicializando pasarela de pago...</div>
      <div id="payment-element"></div>
    </div>

    <button id="submit-button" type="button" disabled>
      <span id="button-text">Pagar ahora</span>
    </button>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  import { showError, handlePayment } from "@/services/payment";
  import { initializePrice, initializeStripe } from "@/services/payment";
  import { getErrorFrontStripe, FrontendStripe } from "@/enums/enums";
  import { getCurrentUserToken, onAuthStateChanged } from "@/services/firebase";
  import { log } from "@/services/logger";
  import { showModalAnimation } from "@/utils/modals";

  // Obtenemos la configuracion inicial
  const STRIPE_PUBLIC_KEY = import.meta.env.PUBLIC_STRIPE_API_KEY;
  const URL_BACKEND = import.meta.env.PUBLIC_BACKEND_URL;

  if (!STRIPE_PUBLIC_KEY || !URL_BACKEND) {
    showError(getErrorFrontStripe(FrontendStripe.MISSING_CONFIG));
    throw new Error("Missing Stripe configuration");
  }

  let stripe: any;
  let elements: any;
  const params = new URLSearchParams(globalThis.location.search);
  const slugType: string | null = params.get("type");
  const bookingUid: string | null = params.get("uid");
  const status: string | null = params.get("status");
  const testCountry: string | null = params.get("test_country");

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", async () => {
    onAuthStateChanged((user) => {
      if (user) {
        try {
          if (!slugType || !bookingUid || !status) {
            log.error("Missing URL parameters, redirecting to home page.");
            showError(getErrorFrontStripe(FrontendStripe.MISSING_URL_PARAMS));
            throw new Error("Missing URL parameters");
          }

          // Esperamos a que cargue firebase antes de inicializar Stripe
          setTimeout(async () => {
            const price = await initializePrice(testCountry, slugType);
            if (!price) {
              log.error("Missing pricing information");
              showError(getErrorFrontStripe(FrontendStripe.MISSING_PRICING));
              throw new Error("Missing pricing information");
            }

            const result = await initializeStripe(STRIPE_PUBLIC_KEY, price);

            if (!result) {
              log.error("Stripe initialization failed");
              showError(getErrorFrontStripe(FrontendStripe.STRIPE_INITIALIZATION_ERROR));
              throw new Error("Stripe initialization failed");
            }

            // Asignar los valores retornados a las variables del scope
            stripe = result.stripe;
            elements = result.elements;

            const submitButton = document.getElementById("submit-button");
            if (!submitButton || !bookingUid) {
              log.error("Submit button not found or missing bookingUid");
              showError(getErrorFrontStripe(FrontendStripe.MISSING_URL_PARAMS));
              throw new Error("Submit button not found or missing bookingUid");
            }

            if (!user.email) {
              log.error("User email is required for payment processing");
              showError(getErrorFrontStripe(FrontendStripe.MISSING_USER_EMAIL));
              throw new Error("User email is required for payment processing");
            }
            /**
             * Procesa el pago mediante Stripe cuando el usuario hace click en el botón de pagar
             * @param stripe - Instancia de Stripe inicializada
             * @param elements - Elementos de Stripe que contienen los datos del formulario de pago
             * @param bookingUid - Identificador único de la reserva
             * @param status - Estado actual de la reserva
             * @param slug - Tipo de clase seleccionada
             * @returns Promise que se resuelve cuando el pago se completa o rechaza si falla
             * @throws {Error} Si el pago es rechazado o hay un error de red
             */
            submitButton.addEventListener("click", () =>
              handlePayment(stripe, elements, bookingUid, status, slugType, user.email as string)
            );
          }, 1000);
        } catch (_) {
          setTimeout(() => {
            globalThis.location.href = "/";
          }, 5000);
        }
      } else {
        log.error("Debes iniciar sesión para proceder al pago.");

        // Mostrar modal de autenticación
        const modalAuth = document.getElementById("authModalLogin") as HTMLDialogElement;
        const form = document.getElementById("loginForm") as HTMLFormElement;

        setTimeout(() => {
          showModalAnimation(modalAuth, form, true);
          // Si cierra el modal volber a abrirlo hasta que inicie sesión
          modalAuth.addEventListener("close", () => {
            if ((!modalAuth.returnValue || modalAuth.returnValue === "closed") && getCurrentUserToken() == null) {
              showModalAnimation(modalAuth, form, true);
            }
          });
        }, 2000);
      }
    });
  });
</script>

<style>
  .container {
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
    font-family: Arial, sans-serif;
  }

  .card {
    border-radius: 8px;
    padding: 30px;
  }

  h1 {
    text-align: center;
    color: #333;
    margin-bottom: 30px;
  }

  .message {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 20px;
    display: none;
  }

  .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .error-message {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  #payment-element {
    margin: 20px 0;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-height: 40px;
  }

  .loading {
    text-align: center;
    color: #666;
    padding: 20px;
  }

  #submit-button {
    width: 100%;
    background-color: var(--color-salmon);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
  }

  #submit-button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }

  #submit-button:hover:not(:disabled) {
    background-color: var(--color-light-brown);
  }
</style>
