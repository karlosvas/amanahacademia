---
import Title from "../common/Title.astro";

const bookingUid = Astro.props.bookingUid as string;
---

<div id="app-config" class="container h-screen">
  <div class="card">
    <Title sizeText="text-lg" sizeLine="h-1" sizeWidth="w-20"> Completa tu pago</Title>

    <!-- Mensajes de estado -->
    <div id="success-message" class="message success"></div>
    <div id="error-message" class="message error-message"></div>

    <!-- Contenedor para los elementos de pago -->
    <div id="payment-element-container">
      <div class="loading">Inicializando pasarela de pago...</div>
      <div id="payment-element"></div>
    </div>

    <button id="submit-button" type="button" disabled>
      <span id="button-text">Pagar ahora</span>
    </button>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  import { ApiService } from "@/services/helper";
  import type {
    CheckoutPaymentIntentResponse,
    Result,
    CheckoutPaymentIntentRequest,
    RelationalCalStripe,
  } from "@/types/bakend-types";

  // Obtenemos la configuracion inicial
  const STRIPE_PUBLIC_KEY = import.meta.env.PUBLIC_STRIPE_API_KEY;
  const url_backend = import.meta.env.PUBLIC_BACKEND_URL;
  const helper = new ApiService();

  let stripe: any;
  let elements: any;
  let paymentElement: any;
  async function initializeStripe() {
    try {
      if (!STRIPE_PUBLIC_KEY || !url_backend)
        throw new Error("Configuración incompleta para el .env. Por favor, contacta al soporte.");

      // Inicializar Stripe, obtenemos el token JWT de Firebase
      stripe = Stripe(STRIPE_PUBLIC_KEY);

      const carry: CheckoutPaymentIntentRequest = {
        amount: 5000,
        currency: "EUR",
        payment_method: "pm_card_visa",
      };

      if (!carry) throw new Error("No se pudo obtener el pedido.");

      const helper = new ApiService();
      let response: Result<CheckoutPaymentIntentResponse> = await helper.checkout(carry);

      // Comprobamos que la respuesta sea válida
      if (!response.success) throw new Error(`Error del servidor: ${response.error}`);
      // Obtenemos el secreto de cliente
      const { client_secret, status } = response.data;

      // 2Crear Stripe Elements
      const appearance = {
        theme: "stripe",
        variables: {
          // Colores principales
          colorPrimary: "#eb5e61", // Color principal botones
          colorBackground: "transparent", // Fondo general
          colorText: "#808080", // Texto principal (gris)
          colorTextSecondary: "#8a4141", // Texto secundario / placeholders
          colorDanger: "#fa8072", // Mensajes de error
          colorSuccess: "#28a745", // Mensajes correctos

          // Tipografía
          fontSizeBase: "16px",
          fontFamily: "Arial, sans-serif",

          // Bordes
          borderRadius: "8px",
        },
        rules: {
          ".Input": {
            padding: "10px",
            border: "1px solid #ddd",
          },
          ".Input:focus": {
            borderColor: "#6d0006",
          },
          ".Button": {
            backgroundColor: "#6d0006",
            color: "#fff",
          },
          ".Button:hover": {
            backgroundColor: "#eb5e61", // Un color bonito, el mismo que el primario
            color: "#fff", // Mantén el texto blanco
            boxShadow: "0 2px 8px rgba(235, 94, 97, 0.2)", // Sombra suave
          },
        },
      };

      elements = stripe.elements({
        clientSecret: client_secret,
        appearance,
      });

      // Crear y montar el Payment Element
      paymentElement = elements.create("payment");

      // Ocultar loading y mostrar el elemento de pago
      const loading = document.querySelector(".loading") as HTMLDivElement | null;
      if (!loading || !loading.style) return;
      loading.style.display = "none";
      await paymentElement.mount("#payment-element");

      // 4️Habilitar el botón de pago
      const submitButton = document.getElementById("submit-button") as HTMLButtonElement | null;
      if (!submitButton) return;
      submitButton.disabled = false;

      // 5️Manejar cambios en el elemento de pago
      paymentElement.on("change", (event: any) => {
        if (event.error) {
          showError(event.error.message);
        } else {
          clearMessages();
        }
      });
    } catch (error: any) {
      console.error("Error inicializando Stripe:", error);
      showError(`Error de inicialización de Stripe`);
    }
  }

  // Función para procesar el pago
  async function handlePayment() {
    if (!stripe || !elements) {
      showError("Stripe no está inicializado correctamente");
      return;
    }

    const submitButton = document.getElementById("submit-button") as HTMLButtonElement | null;
    const buttonText = document.getElementById("button-text") as HTMLButtonElement | null;

    if (!submitButton || !buttonText) {
      showError("No se pudo encontrar el botón de pago");
      return;
    }

    // Deshabilitar botón y mostrar loading
    submitButton.disabled = true;
    buttonText.textContent = "Procesando...";
    clearMessages();

    try {
      // Confirmar el pago
      const { error, paymentIntent } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + "/payment/payment-success",
        },
        redirect: "if_required",
      });

      if (error) {
        // Error en el pago
        if (error.type === "card_error" || error.type === "validation_error") {
          showError(error.message);
        } else {
          showError("Ha ocurrido un error inesperado. Inténtalo de nuevo.");
        }
      } else if (paymentIntent && paymentIntent.status === "succeeded") {
        // Pago exitoso
        showSuccess("¡Pago realizado con éxito! 🎉");

        const bookingUid = new URLSearchParams(window.location.search).get("bookingUid");

        if (!bookingUid) {
          showError("No se encontró el ID de la reserva.");
          return;
        }

        try {
          const responseBookingConfirm = await helper.confirmBooking(bookingUid);
          if (!responseBookingConfirm.success) throw new Error("Error confirmando booking");

          const relation: RelationalCalStripe = {
            cal_id: bookingUid,
            stripe_id: paymentIntent.id,
          };
          const responseSaveRelation = await helper.saveCalStripeConnection(relation);
          if (!responseSaveRelation.success) throw new Error("Error guardando relación en la base de datos");
        } catch (e) {
          console.error("Error al confirmar booking:", e);
        }

        // Opcional: redirigir después de unos segundos
        setTimeout(() => {
          window.location.href = "/payment/payment-success";
        }, 2000);
      } else {
        showError("El estado del pago es incierto. Por favor, verifica tu cuenta.");
      }
    } catch (error) {
      console.error("Error procesando pago:", error);
      showError("Error de conexión. Inténtalo de nuevo.");
    } finally {
      // Rehabilitar el botón
      submitButton.disabled = false;
      buttonText.textContent = "Pagar ahora";
    }
  }

  // Funciones de utilidad para mostrar mensajes
  function showError(message: string) {
    clearMessages();
    const errorDiv = document.getElementById("error-message");
    if (!errorDiv) return;
    errorDiv.textContent = message;
    errorDiv.style.display = "block";
  }

  // Mostrar mensaje de éxito
  function showSuccess(message: string) {
    clearMessages();
    const successDiv = document.getElementById("success-message");
    if (!successDiv) return;
    successDiv.textContent = message;
    successDiv.style.display = "block";
  }

  // Limpiar mensajes
  function clearMessages() {
    document.getElementById("error-message").style.display = "none";
    document.getElementById("success-message").style.display = "none";
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // Esperamos a que cargue firebase antes de inicializar Stripe
      setTimeout(async () => {
        await initializeStripe();

        const submitButton = document.getElementById("submit-button");
        if (!submitButton) return;
        submitButton.addEventListener("click", handlePayment);
      }, 500); // 500ms de espera, ajusta si es necesario
    } catch (e) {
      console.error(e);
    }
  });
</script>
<style>
  .container {
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
    font-family: Arial, sans-serif;
  }

  .card {
    border-radius: 8px;
    padding: 30px;
  }

  h1 {
    text-align: center;
    color: #333;
    margin-bottom: 30px;
  }

  .message {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 20px;
    display: none;
  }

  .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .error-message {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  #payment-element {
    margin: 20px 0;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-height: 40px;
  }

  .loading {
    text-align: center;
    color: #666;
    padding: 20px;
  }

  #submit-button {
    width: 100%;
    background-color: var(--color-salmon);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
  }

  #submit-button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }

  #submit-button:hover:not(:disabled) {
    background-color: var(--color-light-brown);
  }
</style>
