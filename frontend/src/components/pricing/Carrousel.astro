---
interface Props {
  id: string;
  teachers?: Teacher[];
  bookings?: CalBookingPayload[];
}

import type { CalBookingPayload, Teacher } from "@/types/bakend-types";
import TeacherCard from "../common/TeacherCard.astro";
import BookingCard from "../common/BookingCard.astro";

const id = Astro.props.id as string;
const teachers = Astro.props.teachers as Teacher[];
const bookings = Astro.props.bookings as CalBookingPayload[];
---

<section class="max-w-2xl mx-auto py-4 sm:py-6 md:py-8 px-0 md:px-4" aria-label="Carrusel de profesores">
  <div class="relative flex items-center justify-center">
    <button
      type="button"
      class="absolute left-0 sm:left-0 top-1/2 -translate-y-1/2 bg-red text-white rounded-lg sm:rounded-xl w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center z-10 user-select-none text-sm sm:text-lg md:text-xl transition-all duration-300 ease-out opacity-85 hover:opacity-100 hover:scale-105 hover:shadow-xl hover:shadow-red-500/30 active:scale-95 backdrop-blur-sm border border-white/10"
      id={`carousel-prev-${id}`}
      aria-label="Ver profesor anterior"
    >
      &#8592;
    </button>

    <div
      class="overflow-hidden w-full min-h-[450px] max-h-[600px] flex items-center justify-center relative mx-8 sm:mx-10 md:mx-8 p-1 sm:p-2"
      id={`carousel-track-${id}`}
      role="region"
      aria-live="polite"
    >
      {teachers && teachers.map((teacher: Teacher, i: number) => <TeacherCard teacher={teacher} i={i} id={id} />)}
      {bookings && bookings.map((booking: CalBookingPayload, i: number) => <BookingCard booking={booking} i={i} />)}
    </div>

    <button
      type="button"
      class="absolute right-0 sm:right-0 top-1/2 -translate-y-1/2 bg-red text-white rounded-lg sm:rounded-xl w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center z-10 user-select-none text-sm sm:text-lg md:text-xl transition-all duration-300 ease-out opacity-85 hover:opacity-100 hover:scale-105 hover:shadow-xl hover:shadow-red-500/30 active:scale-95 backdrop-blur-sm border border-white/10"
      id={`carousel-next-${id}`}
      aria-label="Ver siguiente profesor"
    >
      &#8594;
    </button>
  </div>

  <!-- Dots de navegación - Solo mostrar si hay más de 1 item -->
  {
    teachers && teachers.length > 1 ? (
      <nav
        class="flex justify-center gap-1 sm:gap-2 mt-3 sm:mt-4"
        id={`carousel-dots-${id}`}
        aria-label="Navegación de profesores"
      >
        {teachers.map((teacher, i) => (
          <button
            type="button"
            class="carousel-dot w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-gray-300 transition-all duration-300 ease-out transform scale-100 hover:scale-110"
            data-index={i}
            aria-label={`Ver perfil de ${teacher.name}`}
            aria-current={i === 0 ? "true" : "false"}
          />
        ))}
      </nav>
    ) : bookings && bookings.length > 1 ? (
      <nav
        class="flex justify-center gap-1 sm:gap-2 mt-3 sm:mt-4"
        id={`carousel-dots-${id}`}
        aria-label="Navegación de reservas"
      >
        {bookings.map((booking, i) => (
          <button
            type="button"
            class="carousel-dot w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-gray-300 transition-all duration-300 ease-out transform scale-100 hover:scale-110"
            data-index={i}
            aria-label={`Ver reserva ${i + 1}`}
            aria-current={i === 0 ? "true" : "false"}
          />
        ))}
      </nav>
    ) : null
  }
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Inicializar todos los carruseles presentes en la página
    const allCarousels = document.querySelectorAll('[id^="carousel-track-"]');
    allCarousels.forEach((carousel) => {
      const carouselId = carousel.id.replace("carousel-track-", "");
      const carrousel = document.getElementById(`carousel-track-${carouselId}`);
      const carrouselDots = document.getElementById(`carousel-dots-${carouselId}`);
      const prevButton = document.getElementById(`carousel-prev-${carouselId}`);
      const nextButton = document.getElementById(`carousel-next-${carouselId}`);

      if (!carrousel || !prevButton || !nextButton) return;

      const slides = Array.from(carrousel.querySelectorAll(".carousel-slide")) as HTMLElement[];
      const dots = carrouselDots ? (Array.from(carrouselDots.querySelectorAll(".carousel-dot")) as HTMLElement[]) : [];
      let current = 0;

      // Ocultar botones si solo hay un profesor
      if (slides.length <= 1) {
        prevButton.style.display = "none";
        nextButton.style.display = "none";
        return;
      }

      function showSlide(idx: number, direction = "right") {
        // Si es el mismo índice, no hacer nada
        if (idx === current) return;

        // Remover clases de animación existentes
        slides.forEach((slide) => {
          slide.classList.remove("active", "exit-right", "exit-left", "enter-right", "enter-left");
        });

        // Aplicar animación de salida al slide actual según la dirección
        slides[current].classList.add(direction === "right" ? "exit-left" : "exit-right");

        // Aplicar animación de entrada al nuevo slide según la dirección
        slides[idx].classList.add(direction === "right" ? "enter-right" : "enter-left");

        // Después de la animación, establecer el nuevo slide como activo
        setTimeout(() => {
          slides.forEach((slide, i) => {
            slide.classList.remove("exit-right", "exit-left", "enter-right", "enter-left");
            slide.setAttribute("aria-hidden", i !== idx ? "true" : "false");
          });
          slides[idx].classList.add("active");
          current = idx;

          // Actualizar dots si existen
          dots.forEach((dot, i) => {
            dot.classList.toggle("active", i === idx);
            dot.setAttribute("aria-current", i === idx ? "true" : "false");
            if (i === idx) {
              dot.style.backgroundColor = "#ef4444";
              dot.style.transform = "scale(1.3)";
              dot.style.boxShadow = "0 0 10px rgba(239, 68, 68, 0.5)";
            } else {
              dot.style.backgroundColor = "#d1d5db";
              dot.style.transform = "scale(1)";
              dot.style.boxShadow = "none";
            }
          });
        }, 600); // Duración de la animación
      }

      // Event listeners para navegación
      prevButton.addEventListener("click", () => {
        showSlide((current - 1 + slides.length) % slides.length, "left");
      });

      nextButton.addEventListener("click", () => {
        showSlide((current + 1) % slides.length, "right");
      });

      // Event listeners para dots
      dots.forEach((dot, i) => {
        dot.addEventListener("click", () => {
          const direction = i > current ? "right" : "left";
          showSlide(i, direction);
        });
      });

      // Inicializar con el primer slide activo
      if (slides.length > 0) {
        slides[0].classList.add("active");
        if (dots.length > 0) {
          dots[0].classList.add("active");
          dots[0].style.backgroundColor = "#ef4444";
          dots[0].style.transform = "scale(1.3)";
          dots[0].style.boxShadow = "0 0 10px rgba(239, 68, 68, 0.5)";
        }
      }
    });
  });
</script>
