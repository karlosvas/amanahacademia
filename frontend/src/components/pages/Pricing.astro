---
import { Class } from "@/enums/enums";
import CardPricing from "@/components/pricing/CardPricing.astro";
import Title from "@/components/common/Title.astro";
import { ApiService } from "@/services/helper";
import type { PricingI18n } from "@/types/types";

const data = Astro.props.data as PricingI18n;

let teachers;
try {
  // Fetch teachers from the API
  const helper = new ApiService();
  const response = await helper.getTeachers();

  // Check if the response is successful and has data
  if (response.success && response.data) teachers = Object.values(response.data);
  else if ("error" in response) console.error("Error fetching teachers:", response.error);
  else console.error("Unknown error fetching teachers");
} catch (e) {
  console.error("Error fetching teachers:", e);
}
---

<main class="relative text-black">
  <style>
    @media (min-width: 768px) and (max-width: 1023px) {
      .grid > :nth-child(3) {
        grid-column: 1 / -1;
        justify-self: center;
        max-width: 50%;
      }
    }
  </style>
  <div class="w-full max-w-7xl xl:w-3/4 m-auto px-2 sm:px-4">
    <Title customStyleText="text-2xl " customStyleLine="w-20 mb-10">{data.title}</Title>
    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 justify-center items-stretch h-auto gap-6 sm:gap-8 md:gap-6 lg:gap-4 w-full max-w-6xl mx-auto px-4 sm:px-6 md:px-8 lg:px-4"
    >
      <CardPricing data={data.type.standard} id={Class.Standard} teachers={teachers} />
      <CardPricing data={data.type.conversation} id={Class.Conversacion} teachers={teachers} />
      <CardPricing data={data.type.group} id={Class.Grupales} teachers={teachers} />
    </div>
    <div
      class="w-full md:w-3/4 flex flex-col md:flex-row text-xs sm:text-sm mt-20 m-auto pb-6 sm:pb-8 md:pb-12 lg:pb-16 xl:pb-20 px-4 sm:px-6 lg:px-12 xl:px-20 md:px-0 gap-4 sm:gap-5 md:gap-6 scroll-fade-in"
    >
      <div class="mx-0 md:mx-3">
        <h4 class="text-salmon text-base sm:text-lg font-semibold">
          {data.info[0].title}
        </h4>
        <p class="mt-2 text-xs sm:text-sm leading-relaxed">
          {data.info[0].description}
        </p>
        <button
          id="free-class-button"
          class="transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-salmon focus:ring-offset-2 bg-red text-salmon dark:text-black py-2 px-4 sm:px-6 md:px-8 lg:px-10 rounded-full mt-3 sm:mt-4 md:mt-5 text-xs sm:text-sm cal-btn font-semibold w-full sm:w-auto"
        >
          {data.info[0].button}
        </button>
      </div>
      <div class="mx-0 md:mx-3 mb-10 md:mb-20">
        <h4 class="text-salmon text-base sm:text-lg font-semibold">
          {data.info[1].title}
        </h4>
        <p class="mt-2 text-xs sm:text-sm leading-relaxed">
          {data.info[1].description}
        </p>
      </div>
    </div>
  </div>
</main>
<div id="cal-inline-root" class="relative mx-auto"></div>

<script>
  import { closeModalAnimation, showModalAnimation } from "@/utils/modals";
  import { Class, FrontendErrorCode, getErrorToast } from "@/enums/enums";
  import { getThemeFromCookie } from "@/utils/cookie";
  import { updatePricing, initCalendar } from "@/services/calendar";
  import { getAuth } from "firebase/auth";
  import toast from "solid-toast";
  import { ApiService } from "@/services/helper";

  // Evento al cargar el DOM
  document.addEventListener("DOMContentLoaded", () => {
    [Class.Conversacion, Class.Grupales, Class.Standard].forEach(initCalendar);

    // Obtenemos todos los botones de reservar clase
    const reserveButtons = document.querySelectorAll(".reserve-class") as NodeListOf<HTMLButtonElement>;
    // Por cada botón obtenemos que modal pertenece, para abrir el que le corresponde al hacer click
    reserveButtons?.forEach((button) => {
      button.addEventListener("click", () => {
        // Obtenemos el modal correspondiente al botón
        const modalID: string | null = button.getAttribute("card-button");
        if (!modalID) return;
        const modal = document.getElementById(modalID) as HTMLDialogElement | null;

        if (modal && modal.id && Object.values(Class).includes(modal.id as Class))
          showModalAnimation(modal, null, true);
      });
    });

    // Añadimos el tema corres pondiente a cada uno de los calendarios
    const calElements = document.querySelectorAll("[data-cal-link]");
    calElements.forEach((element) => {
      element.addEventListener("click", async () => {
        const modal = document.querySelector("dialog[open]") as HTMLDialogElement | null;
        if (modal) closeModalAnimation(modal);

        // Obtenemos el tema actual
        const theme = getThemeFromCookie();

        calElements.forEach((el) => {
          // Obtener config existente (que ya tiene precios)
          const existingConfig = el.getAttribute("data-cal-config");
          let calConfig: { [key: string]: any } = {};

          try {
            calConfig = existingConfig ? JSON.parse(existingConfig) : {};
          } catch (e) {
            console.warn("Error parsing existing cal-config:", e);
            calConfig = {};
          }

          // Añadir solo el tema, preservando precios
          calConfig.theme = theme;

          // Actualizar con configuración completa
          el.setAttribute("data-cal-config", JSON.stringify(calConfig));
        });
      });
    });

    // Manejador para la clase gratuita
    const freeButton = document.getElementById("free-class-button");
    freeButton?.addEventListener("click", async (event) => {
      event?.preventDefault();
      const currentUser = getAuth().currentUser;

      if (!currentUser) {
        toast.error(getErrorToast(FrontendErrorCode.NEED_AUTHENTICATION));
        return;
      } else {
        const helper = new ApiService();
        const userDB = await helper.getUser();

        if (userDB.success && userDB.data.first_free_class) {
          toast.error(getErrorToast(FrontendErrorCode.FREE_CLASS_ALREADY_USED));
          return;
        }

        // Inicializa el calendario si no está ya inicializado
        if (!window.Cal.ns[Class.Free]) {
          initCalendar(Class.Free);
        }

        // Obtener el tema actual para aplicarlo
        const theme = getThemeFromCookie();

        // Abrir el modal de Cal.com programáticamente
        setTimeout(() => {
          window.Cal.ns[Class.Free]("inline", {
            elementOrSelector: "#cal-inline-root",
            calLink: "team/amanah-academia/free-class",
            config: {
              theme: theme,
            },
          });
        }, 200);
      }
    });

    updatePricing();
  });
</script>
