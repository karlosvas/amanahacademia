---
import { Class } from "@/enums/enums";
import CardPricing from "@/components/pricing/CardPricing.astro";
import Title from "@/components/common/Title.astro";
import { ApiService } from "@/services/helper";
import { log } from "@/services/logger";
import type { PricingI18n } from "@/types/types";
import toast from "solid-toast";
import Carrousel from "../pricing/Carrousel.astro";
import type { BookingStatus, CalBookingPayload, Teacher } from "@/types/bakend-types";

const data = Astro.props.data as PricingI18n;

// Obtenemos los profesores desde la API
let teachers;
let bookings;
try {
  // Obtenemos los profesores desde la API
  const helper = new ApiService();
  const response = await helper.getTeachers();

  // Si la respuesta es exitosa, asignamos los datos a la variable teachers
  if (response.success && response.data) teachers = Object.values(response.data);
  else if (!response.success) log.error(response);
  else log.error("Unknown error fetching teachers");

  // Si no hay profesores porque ubo un probelma en el servidor lo redirijimos a /, si no hay profesores mostramos un toast
  if (teachers === undefined || teachers === null) return Astro.redirect("/");
  else if (teachers.length === 0) toast.error("No teachers available at the moment.");

  // Obtenemos las bookings de clases grupales
  let token_cookie = Astro.cookies.get("session")?.value ?? "";
  const bookingsResponse = await helper.getGroupBookings(token_cookie);
  if (bookingsResponse.success && bookingsResponse.data) bookings = bookingsResponse.data;
  else if (!bookingsResponse.success) log.error(bookingsResponse);
  else log.error("Unknown error fetching group bookings");
} catch (e) {
  log.error("Error fetching teachers:", e);
}
---

<main class="relative text-black">
  <div class="w-full max-w-7xl xl:w-3/4 m-auto px-2 sm:px-4">
    <Title customStyleText="text-2xl " customStyleLine="w-20 mb-10">{data.title}</Title>
    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 justify-center items-stretch h-auto gap-6 sm:gap-8 md:gap-6 lg:gap-4 w-full max-w-6xl mx-auto px-4 sm:px-6 md:px-8 lg:px-4"
    >
      <CardPricing data={data.type.standard} id={Class.Standard}>
        <Carrousel id={Class.Standard} teachers={teachers} data={data} />
      </CardPricing>
      <CardPricing data={data.type.conversation} id={Class.Conversacion}>
        <Carrousel id={Class.Conversacion} teachers={teachers} data={data} />
      </CardPricing>
      <CardPricing data={data.type.group} id={Class.Grupales}>
        <Carrousel id={Class.Grupales} bookings={bookings} data={data} />
      </CardPricing>
    </div>
    <div
      class="w-full md:w-11/12 lg:w-4/5 xl:w-3/4 flex flex-col lg:flex-row text-xs sm:text-sm mt-12 sm:mt-16 md:mt-20 m-auto pb-8 md:pb-12 lg:pb-16 xl:pb-20 px-4 sm:px-6 md:px-8 lg:px-6 xl:px-0 gap-6 sm:gap-8 lg:gap-6 scroll-fade-in"
    >
      <div class="flex-1">
        <h4 class="text-salmon text-base sm:text-lg font-semibold">
          {data.info[0].title}
        </h4>
        <p class="mt-2 text-xs sm:text-sm leading-relaxed">
          {data.info[0].description}
        </p>
        <button
          card-button={Class.Free}
          data-modal-id={Class.Free}
          class="reserve-class transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-salmon focus:ring-offset-2 bg-red text-salmon dark:text-black py-2 sm:py-2.5 px-4 sm:px-6 md:px-8 lg:px-10 rounded-full mt-3 sm:mt-4 md:mt-5 text-xs sm:text-sm cal-btn font-semibold w-full sm:w-auto"
        >
          {data.info[0].button}
        </button>
      </div>
      <div class="flex-1">
        <h4 class="text-salmon text-base sm:text-lg font-semibold">
          {data.info[1].title}
        </h4>
        <p class="mt-2 text-xs sm:text-sm leading-relaxed">
          {data.info[1].description}
        </p>
      </div>
      <div class="flex-1">
        <h4 class="text-salmon text-base sm:text-lg font-semibold">
          {data.info[2].title}
        </h4>
        <p class="mt-2 text-xs sm:text-sm leading-relaxed">
          {data.info[2].description}
          <a class="text-salmon font-semibold" href="mailto:anaortegagutierrez99@gmail.com" rel="noopener noreferrer">
            contact@amanahacademia.com
          </a>
        </p>
      </div>
    </div>
  </div>
</main>
<dialog
  id={Class.Free}
  class="modal border-0 rounded-2xl shadow-2xl max-w-2xl w-[95%] mx-auto overflow-hidden p-8 bg-background"
>
  <Carrousel id={Class.Free} teachers={teachers} />
</dialog>
<div id="cal-inline-root" class="relative mx-auto"></div>

<script>
  import { closeModalAnimation, showModalAnimation, startCalScrollManagement } from "@/utils/modals";
  import { Class, FrontendErrorCode, getErrorToast } from "@/enums/enums";
  import { updatePricing, initCalendar } from "@/services/calendar";
  import { getAuth } from "firebase/auth";
  import toast from "solid-toast";
  import { ApiService } from "@/services/helper";
  import { log } from "@/services/logger";
  import { getThemeFromCookie } from "@/utils/cookie";

  // Evento al cargar el DOM
  document.addEventListener("DOMContentLoaded", () => {
    [Class.Conversacion, Class.Grupales, Class.Standard, Class.Free].forEach(initCalendar);

    // Obtenemos todos los botones de reservar clase
    const reserveButtons = document.querySelectorAll(".reserve-class") as NodeListOf<HTMLButtonElement>;
    // Por cada botón obtenemos que modal pertenece, para abrir el que le corresponde al hacer click
    reserveButtons?.forEach(async (button) => {
      button.addEventListener("click", async () => {
        // Obtenemos el modal correspondiente al botón
        const modalID: string | null = button.getAttribute("card-button");
        if (!modalID) return;
        const modal = document.getElementById(modalID) as HTMLDialogElement | null;

        if (modal == null) {
          log.error("Modal not found for ID:", modalID);
          return;
        }

        // Manejador para la clase gratuita
        if (modal.id === Class.Free) {
          const currentUser = getAuth().currentUser;
          if (!currentUser) {
            toast.error(getErrorToast(FrontendErrorCode.NEED_AUTHENTICATION));
            return;
          } else {
            const helper = new ApiService();
            const userDB = await helper.getUser();
            if (userDB.success && userDB.data.first_free_class) {
              toast.error(getErrorToast(FrontendErrorCode.FREE_CLASS_ALREADY_USED));
              return;
            }
          }
        }

        // Manejamos el scroll que nos quita cal.com al abrir el modal
        showModalAnimation(modal, null, true);

        // Siempre observamos el modal que se acaba de abrir para manejar el scroll
        startCalScrollManagement();
      });
    });

    // Añadimos el tema correspondiente a cada uno de los calendarios
    const calElements = document.querySelectorAll("[data-cal-link]");
    calElements.forEach((element) => {
      element.addEventListener("click", async () => {
        const modal = document.querySelector("dialog[open]") as HTMLDialogElement | null;
        if (modal) closeModalAnimation(modal);

        // Obtenemos el tema actual
        const theme = getThemeFromCookie();

        calElements.forEach((el) => {
          // Obtener config existente (que ya tiene precios)
          const existingConfig = el.getAttribute("data-cal-config");
          let calConfig: { [key: string]: any } = {};

          try {
            calConfig = existingConfig ? JSON.parse(existingConfig) : {};
          } catch (e) {
            console.warn("Error parsing existing cal-config:", e);
            calConfig = {};
          }

          // Añadir solo el tema, preservando precios
          calConfig.theme = theme;

          // Actualizar con configuración completa
          el.setAttribute("data-cal-config", JSON.stringify(calConfig));
        });
      });
    });

    updatePricing();
  });
</script>

<style>
  @media (min-width: 768px) and (max-width: 1023px) {
    .grid > :nth-child(3) {
      grid-column: 1 / -1;
      justify-self: center;
      max-width: 50%;
    }
  }
</style>
