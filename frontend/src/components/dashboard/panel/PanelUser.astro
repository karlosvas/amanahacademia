---
import { log } from "@/services/logger";
import UserInfoPanel from "../UserInfoPanel.astro";
import { ApiService } from "@/services/helper";
import type { ResponseAPI, Booking } from "@/types/bakend-types";

const helper = new ApiService();

const token_cookie = Astro.cookies.get("auth")?.value ?? "";

if (!token_cookie) {
  log.error("Deves iniciar sesion primero");
  // return Astro.redirect("/");
}

const classID: ResponseAPI<string[]> = await helper.getAllPaidReservations(token_cookie);

if (!classID.success) {
  log.error("Error al obtener id de bookings");
  // return Astro.redirect("/");
} else {
  log.info(classID.data);
  // Crear todas las promesas
  const bookingPromises = classID.data.map((id) => helper.getBookingById(id));

  // Ejecutar todas en paralelo
  const bookingResponses = await Promise.all(bookingPromises);

  // Filtrar solo las exitosas
  const listOfClass: Booking[] = bookingResponses
    .filter((response) => {
      if (!response.success) {
        log.error(response);
        log.error(`Error al obtener booking: ${response.error}`);
        return false;
      }
      return true;
    })
    .map((response) => response.data);

  log.info(`Obtenidos ${listOfClass.length} bookings de ${classID.data.length} totales`);
}
---

<h1 class="text-red text-4xl font-bold">Usuarios</h1>
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <!-- {listOfClass.map((e) => <UserInfoPanel title="" value="" change="" iconType="users" />)} -->
</div>
