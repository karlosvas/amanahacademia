---
import { log } from "@/services/logger";
import { ApiService } from "@/services/helper";
import type { ResponseAPI, Teacher } from "@/types/bakend-types";

const helper = new ApiService();

const token_cookie = Astro.cookies.get("session")?.value ?? "";
if (!token_cookie) log.error("Debes iniciar sesión primero");

// Obtener lista de profesores para el selector
let teachers: Teacher[] = [];
try {
  const teachersResponse: ResponseAPI<Teacher[]> = await helper.getTeachers();
  if (teachersResponse.success) {
    teachers = teachersResponse.data;
  } else {
    log.error(`Error al obtener profesores: ${teachersResponse.error}`);
  }
} catch (error) {
  log.error("Error al cargar profesores:", error);
}
---

<section>
  <h1 class="text-red text-4xl font-bold my-10">Crear Nueva Clase</h1>

  <div class="bg-[#fff4e1] rounded-xl shadow-sm p-8 border border-[#fee8d6] max-w-4xl">
    <form id="create-class-form" class="space-y-6">
      <!-- Fecha y hora -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="class-date" class="block text-sm font-bold text-[#131313] mb-2">
            Fecha de la clase *
          </label>
          <input
            type="date"
            id="class-date"
            name="class-date"
            required
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
          />
        </div>

        <div>
          <label for="class-time" class="block text-sm font-bold text-[#131313] mb-2">
            Hora de inicio *
          </label>
          <input
            type="time"
            id="class-time"
            name="class-time"
            required
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
          />
        </div>
      </div>

      <!-- Profesor asignado -->
      <div>
        <label for="teacher" class="block text-sm font-bold text-[#131313] mb-2">
          Profesor asignado *
        </label>
        <select
          id="teacher"
          name="teacher"
          required
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
        >
          <option value="">Selecciona un profesor</option>
          {
            teachers.map((teacher) => (
              <option value={teacher.cal_id}>
                {teacher.name} - {teacher.native_lang}
              </option>
            ))
          }
        </select>
      </div>

      <!-- Nivel de idioma -->
      <div>
        <label for="language-level" class="block text-sm font-bold text-[#131313] mb-2">
          Nivel de idioma *
        </label>
        <select
          id="language-level"
          name="language-level"
          required
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
        >
          <option value="">Selecciona un nivel</option>
          <option value="A1">A1 - Principiante</option>
          <option value="A2">A2 - Elemental</option>
          <option value="B1">B1 - Intermedio</option>
          <option value="B2">B2 - Intermedio Alto</option>
          <option value="C1">C1 - Avanzado</option>
          <option value="C2">C2 - Maestría</option>
        </select>
      </div>

      <!-- Capacidad de la clase -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="min-students" class="block text-sm font-bold text-[#131313] mb-2">
            Cantidad mínima de estudiantes *
          </label>
          <input
            type="number"
            id="min-students"
            name="min-students"
            min="1"
            max="20"
            required
            placeholder="Ej: 2"
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
          />
          <p class="text-xs text-gray-600 mt-1">Mínimo requerido para abrir la clase</p>
        </div>

        <div>
          <label for="max-students" class="block text-sm font-bold text-[#131313] mb-2">
            Cantidad máxima de estudiantes *
          </label>
          <input
            type="number"
            id="max-students"
            name="max-students"
            min="1"
            max="20"
            required
            placeholder="Ej: 8"
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
          />
          <p class="text-xs text-gray-600 mt-1">Capacidad máxima de la clase</p>
        </div>
      </div>

      <!-- Duración de la clase -->
      <div>
        <label for="duration" class="block text-sm font-bold text-[#131313] mb-2">
          Duración de la clase (minutos) *
        </label>
        <select
          id="duration"
          name="duration"
          required
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white"
        >
          <option value="30">30 minutos</option>
          <option value="45">45 minutos</option>
          <option value="60" selected>60 minutos</option>
          <option value="90">90 minutos</option>
          <option value="120">120 minutos</option>
        </select>
      </div>

      <!-- Descripción adicional -->
      <div>
        <label for="description" class="block text-sm font-bold text-[#131313] mb-2">
          Descripción adicional (opcional)
        </label>
        <textarea
          id="description"
          name="description"
          rows="4"
          placeholder="Añade información adicional sobre la clase..."
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] bg-white resize-none"
        ></textarea>
      </div>

      <!-- Mensaje de error/éxito -->
      <div id="form-message" class="hidden p-4 rounded-lg"></div>

      <!-- Botones de acción -->
      <div class="flex gap-4 pt-4">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 bg-[#8a4141] hover:bg-[#6d3333] text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200"
        >
          Crear Clase
        </button>
        <button
          type="reset"
          class="px-6 py-3 border-2 border-[#8a4141] text-[#8a4141] font-bold rounded-lg hover:bg-[#8a4141] hover:text-white transition-colors duration-200"
        >
          Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- Sección de clases creadas (para futura implementación) -->
  <div class="mt-12">
    <h2 class="text-red text-3xl font-bold mb-6">Clases Programadas</h2>
    <div id="classes-list" class="space-y-4">
      <!-- Aquí se listarán las clases existentes -->
      <p class="text-gray-600 text-center py-8">No hay clases programadas aún</p>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("create-class-form") as HTMLFormElement;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
    const formMessage = document.getElementById("form-message") as HTMLDivElement;
    const minStudentsInput = document.getElementById("min-students") as HTMLInputElement;
    const maxStudentsInput = document.getElementById("max-students") as HTMLInputElement;

    // Validación en tiempo real
    const validateStudentCounts = () => {
      const min = parseInt(minStudentsInput.value);
      const max = parseInt(maxStudentsInput.value);

      if (min && max && min > max) {
        maxStudentsInput.setCustomValidity("El máximo debe ser mayor o igual al mínimo");
      } else {
        maxStudentsInput.setCustomValidity("");
      }
    };

    minStudentsInput.addEventListener("input", validateStudentCounts);
    maxStudentsInput.addEventListener("input", validateStudentCounts);

    // Mostrar mensaje
    const showMessage = (message: string, isError: boolean = false) => {
      formMessage.textContent = message;
      formMessage.className = `p-4 rounded-lg ${
        isError ? "bg-red-100 text-red-700 border border-red-300" : "bg-green-100 text-green-700 border border-green-300"
      }`;
      formMessage.classList.remove("hidden");

      setTimeout(() => {
        formMessage.classList.add("hidden");
      }, 5000);
    };

    // Manejo del envío del formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Validar formulario
      if (!form.checkValidity()) {
        showMessage("Por favor, completa todos los campos requeridos", true);
        return;
      }

      // Deshabilitar botón durante el envío
      submitBtn.disabled = true;
      submitBtn.textContent = "Creando clase...";

      try {
        const formData = new FormData(form);

        // Construir objeto de clase
        const classData = {
          date: formData.get("class-date"),
          time: formData.get("class-time"),
          teacher_id: formData.get("teacher"),
          language_level: formData.get("language-level"),
          min_students: parseInt(formData.get("min-students") as string),
          max_students: parseInt(formData.get("max-students") as string),
          duration: parseInt(formData.get("duration") as string),
          description: formData.get("description") || "",
        };

        console.log("Datos de la clase:", classData);

        // TODO: Implementar llamada al backend
        // const response = await fetch('/api/classes/create', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(classData)
        // });

        // Simulación de respuesta exitosa
        await new Promise((resolve) => setTimeout(resolve, 1000));

        showMessage("¡Clase creada exitosamente!", false);
        form.reset();
      } catch (error) {
        console.error("Error al crear clase:", error);
        showMessage("Error al crear la clase. Por favor, inténtalo de nuevo.", true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Crear Clase";
      }
    });
  });
</script>
