---
import { log } from "@/services/logger";
import { ApiService } from "@/services/helper";
import BookingCard from "@/components/common/BookingCard.astro";
import type { ResponseAPI, Teacher, Availability, Schedule, CalBookingPayload } from "@/types/bakend-types";

const helper = new ApiService();

// Obtener lista de profesores para el selector
let teachers: Teacher[] = [];
let timeSlots: Availability | null = null;
let bookingsList: CalBookingPayload[] | null = null;
try {
  const teachersResponse: ResponseAPI<Teacher[]> = await helper.getTeachers();
  if (teachersResponse.success) teachers = Object.values(teachersResponse.data);
  else {
    log.error(`Error al obtener profesores: ${teachersResponse.error}`);
    throw new Error();
  }

  const timeSlotsResponse: ResponseAPI<Schedule> = await helper.getAvailableTimeSchedule("1081935");

  if (timeSlotsResponse.success) timeSlots = timeSlotsResponse.data.availability[0];
  else {
    log.error(`Error al obtener franjas horarias: ${timeSlotsResponse.error}`);
    throw new Error();
  }

  log.info(timeSlots);

  let token_cookie = Astro.cookies.get("session")?.value ?? "";
  const bookingsListResponse: ResponseAPI<CalBookingPayload[]> = await helper.getGroupBookings(token_cookie);
  if (bookingsListResponse.success) bookingsList = bookingsListResponse.data;
  else {
    log.error(`Error al obtener lista de reservas: ${bookingsListResponse.error}`);
    throw new Error();
  }
} catch (error) {
  log.error("Error al cargar profesores:", error);
}
---

<section>
  <h1 class="text-red text-4xl font-bold my-10">Crear Nueva Clase</h1>

  <div class="bg-[#fff4e1] rounded-xl shadow-sm p-8 border border-[#fee8d6] max-w-4xl">
    <form id="create-class-form" class="space-y-6">
      <!-- Fecha y hora -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="class-date" class="block text-sm font-bold text-[#131313] mb-2"> Fecha de la clase * </label>
          <input
            type="date"
            id="class-date"
            name="class-date"
            required
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141]"
          />
          <p class="text-xs text-gray-600 mt-1">La clase debe ser programada para una fecha futura</p>
        </div>

        <div>
          <label for="class-time" class="block text-sm font-bold text-[#131313] mb-2"> Hora de inicio * </label>
          <input
            type="time"
            id="class-time"
            name="class-time"
            min={timeSlots?.start_time?.toString() ?? "15:00"}
            max={timeSlots?.end_time?.toString() ?? "20:00"}
            required
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141]"
          />
          <p class="text-xs text-gray-600 mt-1">
            Horario disponible: {timeSlots?.start_time?.toString() ?? "15:00"} - {
              timeSlots?.end_time?.toString() ?? "20:00"
            }
          </p>
        </div>
      </div>

      <!-- Profesor asignado -->
      <div>
        <label for="teacher" class="block text-sm font-bold text-[#131313] mb-2"> Profesor asignado * </label>
        <select
          id="teacher"
          name="teacher"
          required
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141]"
        >
          <option value="">Selecciona un profesor</option>
          {
            teachers.map((teacher) => (
              <option value={teacher.cal_id} data-calLink={teacher.cal_link} data-teacherName={teacher.name}>
                {teacher.name} - {teacher.native_lang}
              </option>
            ))
          }
        </select>
      </div>

      <!-- Nivel de idioma -->
      <div>
        <label for="language-level" class="block text-sm font-bold text-[#131313] mb-2"> Nivel de idioma * </label>
        <select
          id="language-level"
          name="language-level"
          required
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141]"
        >
          <option value="">Selecciona un nivel</option>
          <option value="A1">A1 - Principiante</option>
          <option value="A2">A2 - Elemental</option>
          <option value="B1">B1 - Intermedio</option>
          <option value="B2">B2 - Intermedio Alto</option>
          <option value="C1">C1 - Avanzado</option>
          <option value="C2">C2 - Maestría</option>
        </select>
      </div>

      <!-- Capacidad de la clase -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="min-students" class="block text-sm font-bold text-[#131313] mb-2">
            Cantidad mínima de estudiantes *
          </label>
          <input
            type="number"
            id="min-students"
            name="min-students"
            min="1"
            max="20"
            required
            placeholder="Ej: 2"
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141]"
          />
          <p class="text-xs text-gray-600 mt-1">Mínimo requerido para abrir la clase</p>
        </div>

        <div>
          <label for="max-students" class="block text-sm font-bold text-[#131313] mb-2">
            Cantidad máxima de estudiantes *
          </label>
          <input
            type="number"
            id="max-students"
            name="max-students"
            min="1"
            max="20"
            required
            placeholder="Ej: 8"
            class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141]"
          />
          <p class="text-xs text-gray-600 mt-1">Capacidad máxima de la clase</p>
        </div>
      </div>

      <!-- Descripción adicional -->
      <div>
        <label for="description" class="block text-sm font-bold text-[#131313] mb-2">
          Descripción adicional (opcional)
        </label>
        <textarea
          id="description"
          name="description"
          rows="4"
          placeholder="Añade información adicional sobre la clase..."
          class="w-full px-4 py-2 border border-[#fee8d6] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4141] resize-none"
        ></textarea>
      </div>

      <!-- Mensaje de error/exito -->
      <div id="form-message" class="hidden p-4 rounded-lg"></div>

      <!-- Botones de acción -->
      <div class="flex gap-4 pt-4">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 bg-[#8a4141] hover:bg-[#6d3333] text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200"
        >
          Crear Clase
        </button>
        <button
          type="reset"
          class="px-6 py-3 border-2 border-[#8a4141] text-[#8a4141] font-bold rounded-lg hover:bg-[#8a4141] hover:text-white transition-colors duration-200"
        >
          Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- Horarios disponibles para reservar -->
  <div class="my-20">
    <h2 class="text-red text-3xl font-bold mb-6">Horarios Disponibles para Reservar</h2>
    <div class="bg-gradient-to-r from-[#fff4e1] to-[#ffe8cc] rounded-xl shadow-lg p-8 border border-[#fee8d6] max-w-4xl">
      {timeSlots && (
        <div class="space-y-6">
          <!-- Horario -->
          <div class="flex items-center gap-4 pb-4 border-b border-[#fee8d6]">
            <div class="bg-[#8a4141] text-white p-3 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600 font-medium">Horario disponible</p>
              <p class="text-2xl font-bold text-[#8a4141]">
                {(timeSlots as any).startTime || timeSlots.start_time} - {(timeSlots as any).endTime || timeSlots.end_time }
              </p>
            </div>
          </div>

          <!-- Días disponibles -->
          <div>
            <div class="flex items-center gap-2 mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#8a4141]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-sm text-gray-600 font-medium">Días disponibles</p>
            </div>
            <div class="flex flex-wrap gap-2">
              {timeSlots.days.map((day: string) => (
                <span class="px-4 py-2 bg-white text-[#8a4141] font-semibold rounded-full border-2 border-[#8a4141] shadow-sm">
                  {day === 'Monday' ? 'Lunes' :
                   day === 'Tuesday' ? 'Martes' :
                   day === 'Wednesday' ? 'Miércoles' :
                   day === 'Thursday' ? 'Jueves' :
                   day === 'Friday' ? 'Viernes' :
                   day === 'Saturday' ? 'Sábado' :
                   day === 'Sunday' ? 'Domingo' : day}
                </span>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  </div>

  <div class="my-20">
    <h2 class="text-red text-3xl font-bold mb-6">Clases Programadas</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 w-full">
      {
        bookingsList && bookingsList.length > 0 ? (
          bookingsList.map((booking: CalBookingPayload, i: number) => (
            <BookingCard booking={booking} i={i} showDetails={true} />
          ))
        ) : (
          <p class="text-gray-600 text-center py-8 col-span-full">No hay clases programadas aún</p>
        )
      }
    </div>
  </div>
</section>

<script>
  import { ApiService } from "@/services/helper";
  import { log } from "@/services/logger";
  import type { BookingRequest, CalBookingPayload, ResponseAPI } from "@/types/bakend-types";

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("create-class-form") as HTMLFormElement;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
    const formMessage = document.getElementById("form-message") as HTMLDivElement;
    const minStudentsInput = document.getElementById("min-students") as HTMLInputElement;
    const maxStudentsInput = document.getElementById("max-students") as HTMLInputElement;
    const dateInput = document.getElementById("class-date") as HTMLInputElement;
    const timeInput = document.getElementById("class-time") as HTMLInputElement;

    // Configurar fecha mínima (hoy)
    const today = new Date().toISOString().split("T")[0];
    dateInput.setAttribute("min", today);

    // Validación en tiempo real
    const validateStudentCounts = () => {
      const min = Number.parseInt(minStudentsInput.value);
      const max = Number.parseInt(maxStudentsInput.value);

      if (min && max && min > max) {
        maxStudentsInput.setCustomValidity("El máximo debe ser mayor o igual al mínimo");
      } else {
        maxStudentsInput.setCustomValidity("");
      }
    };

    // Validar que la hora esté en el rango permitido (15:00 - 20:00)
    const validateTime = () => {
      const time = timeInput.value;
      if (time) {
        const [hours, minutes] = time.split(":").map(Number);
        const timeInMinutes = hours * 60 + minutes;
        const minTime = 15 * 60; // 15:00
        const maxTime = 20 * 60; // 20:00

        if (timeInMinutes < minTime || timeInMinutes > maxTime) {
          timeInput.setCustomValidity("La hora debe estar entre 15:00 y 20:00");
        } else {
          timeInput.setCustomValidity("");
        }
      }
    };

    // Validar que la fecha sea futura
    const validateDate = () => {
      const selectedDate = dateInput.value;
      if (selectedDate) {
        const selected = new Date(selectedDate + "T00:00:00");
        const now = new Date();
        now.setHours(0, 0, 0, 0);

        if (selected < now) {
          dateInput.setCustomValidity("La fecha debe ser hoy o posterior");
        } else {
          dateInput.setCustomValidity("");
        }
      }
    };

    minStudentsInput.addEventListener("input", validateStudentCounts);
    maxStudentsInput.addEventListener("input", validateStudentCounts);
    timeInput.addEventListener("input", validateTime);
    dateInput.addEventListener("input", validateDate);

    // Mostrar mensaje
    const showMessage = (message: string, isError: boolean = false) => {
      formMessage.textContent = message;
      formMessage.className = `p-4 rounded-lg ${
        isError
          ? "bg-red-100 text-red-700 border border-red-300"
          : "bg-green-100 text-green-700 border border-green-300"
      }`;
      formMessage.classList.remove("hidden");

      setTimeout(() => {
        formMessage.classList.add("hidden");
      }, 5000);
    };

    // Convertir fecha y hora a ISO 8601
    const toISO8601 = (date: string, time: string): string => {
      // date: "2025-11-26", time: "14:30"
      const dateTime = new Date(`${date}T${time}:00`);
      return dateTime.toISOString(); // "2025-11-26T14:30:00.000Z"
    };

    // Manejo del envío del formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Validar todos los campos antes de enviar
      validateStudentCounts();
      validateTime();
      validateDate();

      if (!form.checkValidity()) {
        showMessage("Por favor, completa todos los campos requeridos correctamente", true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Creando clase...";

      try {
        const formData = new FormData(form);

        const date = formData.get("class-date") as string;
        const time = formData.get("class-time") as string;

        // Validación adicional del horario permitido
        const [hours] = time.split(":").map(Number);
        if (hours < 15 || hours > 20) {
          showMessage("La hora debe estar entre 15:00 y 20:00", true);
          submitBtn.disabled = false;
          submitBtn.textContent = "Crear Clase";
          return;
        }

        // Calcular start y end en ISO 8601
        const startISO = toISO8601(date, time);
        const startDate = new Date(startISO);
        const endDate = new Date(startDate.getTime() + 60 * 60000);
        const endISO = endDate.toISOString();

        // Obtener el profesor seleccionado
        const teacherSelect = document.getElementById("teacher") as HTMLSelectElement;
        const selectedOption = teacherSelect.selectedOptions[0];

        // Obtenemos el calLink del profesor seleccionado (por si se necesita en el futuro)
        const teacherCalLink = selectedOption.getAttribute("data-calLink") || "";

        // Obtenemos el calLink del profesor seleccionado (por si se necesita en el futuro)
        const bookingData: BookingRequest = {
          startTime: startISO,
          endTime: endISO,
          username: teacherCalLink,
          type: "group-class",
          description: (formData.get("description") as string) || undefined,
          attendees: [
            {
              name: "placeholder",
              email: "carlosvassan@gmail.com",
              timeZone: "Europe/Madrid",
              language: "es",
            },
          ],
          metadata: {
            teacher_id: formData.get("teacher") as string,
            language_level: formData.get("language-level") as string,
            min_students: formData.get("min-students") as string,
            max_students: formData.get("max-students") as string,
            current_students: "1",
          },
          status: "pending",
        };

        const helper = new ApiService();
        const response: ResponseAPI<CalBookingPayload> = await helper.createBooking(bookingData);
        if (response.success) {
          showMessage("Clase creada exitosamente!", false);
          form.reset();
          // Recargar la página después de 2 segundos para mostrar la nueva clase
          setTimeout(() => {
            globalThis.location.reload();
          }, 5000);
        } else {
          log.error(response.error);
          // Mostrar un mensaje más descriptivo si es un error de Cal.com
          const errorMsg = response.error || "Error al crear la clase";
          if (errorMsg.includes("can't be booked at")) {
            showMessage(
              "Error: El horario seleccionado no está disponible en Cal.com. Verifica que el tipo de evento 'group-class' existe y permite reservas para esta fecha/hora.",
              true
            );
          } else if (errorMsg.includes("eventTypeId or eventTypeSlug")) {
            showMessage(
              "Error de configuración: Falta información del tipo de evento. Contacta al administrador.",
              true
            );
          } else {
            showMessage(errorMsg, true);
          }
        }
      } catch (error) {
        log.error("Error al crear clase:", error);
        showMessage("Error al crear la clase. Por favor, inténtalo de nuevo.", true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Crear Clase";
      }
    });
  });
</script>
