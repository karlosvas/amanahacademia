---
import EmailIcon from "@/assets/email.svg";
import type { ModalI18n } from "@/types/types";

const data = Astro.props.data as ModalI18n;
---

<dialog
  id="passwordResetModal"
  class="modal border-0 rounded-2xl p-0 max-w-md w-[90%] shadow-2xl bg-gradient-to-br from-white to-smoothBrown overflow-hidden font-normal text-sm"
>
  <div class="p-8 relative">
    <!-- Close Button -->
    <button
      id="closeResetModal"
      class="absolute top-4 right-4 w-10 h-10 rounded-full bg-lightSalmon hover:bg-red text-brown hover:text-white transition-all duration-300 flex items-center justify-center font-light border-0 cursor-pointer shadow-sm hover:shadow-md transform hover:scale-110"
      aria-label="close-modal"
    >
      ×
    </button>

    <!-- Header -->
    <div class="text-center mb-8 mt-4">
      <div
        class="w-16 h-16 bg-gradient-to-br from-salmon to-brown rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg"
      >
        <EmailIcon />
      </div>
      <h2 class="text-xl font-bold text-brown mb-2">{data.reset_password.title}</h2>
      <p class="text-lightBrown text-xs">{data.reset_password.subtitle}</p>
    </div>

    <!-- Form -->
    <form class="space-y-4" id="resetPasswordForm">
      <!-- Email Input -->
      <div class="relative">
        <input
          type="email"
          name="email"
          id="resetEmail"
          placeholder={data.utils.labels.email}
          class="w-full pl-12 pr-4 py-3 bg-white border border-lightSalmon rounded-lg focus:outline-none focus:ring-2 focus:ring-salmon focus:border-transparent transition-all duration-200 text-brown placeholder-lightBrown"
        />
        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-brown opacity-60">
          <EmailIcon />
        </div>
      </div>

      <!-- Error Message -->
      <div id="resetError" class="hidden text-red text-xs p-2 bg-red-100 rounded"></div>

      <!-- Success Message -->
      <div id="resetSuccess" class="hidden text-green-600 text-xs p-2 bg-green-100 rounded"></div>

      <!-- Loading Spinner -->
      <div id="resetLoading" class="hidden text-center">
        <div class="inline-block w-8 h-8 border-4 border-salmon border-t-transparent rounded-full animate-spin"></div>
        <p class="text-lightBrown text-xs mt-2">{data.utils.loading}</p>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        class="w-full bg-gradient-to-r from-salmon to-brown text-white py-3 rounded-lg font-medium hover:shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 border-0 cursor-pointer"
      >
        {data.reset_password.button}
      </button>

      <!-- Back to Login -->
      <div class="text-center">
        <a
          href="#"
          id="backToLogin"
          class="text-salmon hover:text-brown font-medium hover:underline transition-colors duration-200"
        >
          {data.reset_password.back_to_login}
        </a>
      </div>
    </form>
  </div>
</dialog>

<script>
  import { sendPasswordResetEmail } from "firebase/auth";
  import { getFirebaseAuth } from "@/services/firebase";
  import { FrontendErrorCode, getErrorToast, AuthSuccessCode, getAuthSuccessMessage } from "@/enums/enums";
  import { log } from "@/services/logger";

  document.addEventListener("DOMContentLoaded", () => {
    const resetModal = document.getElementById("passwordResetModal") as HTMLDialogElement;
    const resetForm = document.getElementById("resetPasswordForm") as HTMLFormElement;
    const resetError = document.getElementById("resetError") as HTMLDivElement;
    const resetSuccess = document.getElementById("resetSuccess") as HTMLDivElement;
    const resetLoading = document.getElementById("resetLoading") as HTMLDivElement;
    const closeResetModal = document.getElementById("closeResetModal") as HTMLButtonElement;
    const backToLogin = document.getElementById("backToLogin") as HTMLAnchorElement;

    // Cerrar modal
    closeResetModal.addEventListener("click", () => {
      resetModal.close();
      resetForm.reset();
      resetError.classList.add("hidden");
      resetSuccess.classList.add("hidden");
    });

    // Volver al login
    backToLogin.addEventListener("click", (e) => {
      e.preventDefault();
      resetModal.close();
      resetForm.reset();
      resetError.classList.add("hidden");
      resetSuccess.classList.add("hidden");
      resetLoading.classList.add("hidden");

      // Abrir modal de login
      const loginModal = document.getElementById("authModalLogin") as HTMLDialogElement;
      if (loginModal) loginModal.showModal();
      else log.error("Login modal not found");
    });

    // Obtener el envio del formulario
    resetForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const emailInput = resetForm.querySelector('input[name="email"]') as HTMLInputElement;
      const email = emailInput.value.trim();

      // Ocultar mensajes previos
      resetError.classList.add("hidden");
      resetSuccess.classList.add("hidden");

      // Validar email
      if (!email) {
        resetError.textContent = getErrorToast(FrontendErrorCode.EMAIL_REQUIRED_RESET);
        resetError.classList.remove("hidden");
        return;
      }

      // Mostrar carga
      resetLoading.classList.remove("hidden");

      try {
        const auth = getFirebaseAuth();

        // Intentar enviar el correo de restablecimiento
        // Firebase manejará automáticamente si el usuario existe o no
        // Por seguridad, Firebase NO revela si:
        // - El usuario existe
        // - El usuario se registró con password o con OAuth
        // Siempre mostrará éxito para evitar enumeration attacks
        await sendPasswordResetEmail(auth, email);

        // Ocultar carga
        resetLoading.classList.add("hidden");

        // Mostrar mensaje de éxito
        resetSuccess.textContent = getAuthSuccessMessage(AuthSuccessCode.RESET_SUCCESS);
        resetSuccess.classList.remove("hidden");

        // Limpiar formulario
        resetForm.reset();

        log.info("Correo de restablecimiento de contraseña enviado con éxito a:", email);

        setTimeout(() => {
          resetModal.close();
          resetForm.reset();
          resetError.classList.add("hidden");
          resetSuccess.classList.add("hidden");
        }, 5000);
      } catch (error: any) {
        // Ocultar carga
        resetLoading.classList.add("hidden");

        // Mostrar mensaje de error
        log.error("Error al enviar el correo de restablecimiento de contraseña:", error);
        log.info("Código de error:", error.code);
        log.info("Mensaje de error:", error.message);

        // Manejar diferentes tipos de errores de Firebase
        switch (error.code) {
          case "auth/user-not-found":
            // Usuario no existe - pero Firebase ya no devuelve este error
            // en versiones recientes para evitar enumeration attacks
            resetError.textContent = getErrorToast(FrontendErrorCode.USER_NOT_EXISTS);
            break;

          case "auth/invalid-email":
            resetError.textContent = getErrorToast(FrontendErrorCode.EMAIL_REQUIRED_RESET);
            break;

          case "auth/user-disabled":
            // Cuenta deshabilitada
            resetError.textContent = getErrorToast(FrontendErrorCode.FORBIDDEN);
            break;

          case "auth/too-many-requests":
            // Demasiados intentos
            resetError.textContent = getErrorToast(FrontendErrorCode.NETWORK_ERROR);
            break;

          case "auth/missing-android-pkg-name":
          case "auth/missing-continue-uri":
          case "auth/missing-ios-bundle-id":
          case "auth/invalid-continue-uri":
          case "auth/unauthorized-continue-uri":
            // Errores de configuración
            resetError.textContent = getErrorToast(FrontendErrorCode.UNKNOWN_ERROR);
            break;

          default:
            // Por defecto, mostrar mensaje genérico
            // Nota: Firebase ya no revela si un usuario existe o su método de autenticación
            // por razones de seguridad, así que puede mostrar éxito incluso si no envió nada
            resetError.textContent = getErrorToast(FrontendErrorCode.UNKNOWN_ERROR);
            break;
        }

        resetError.classList.remove("hidden");
      }
    });

    // Close modal when clicking outside
    resetModal.addEventListener("click", (e) => {
      if (e.target === resetModal) {
        resetModal.close();
        resetForm.reset();
        resetError.classList.add("hidden");
        resetSuccess.classList.add("hidden");
      }
    });
  });
</script>
