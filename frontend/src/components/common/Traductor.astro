---
import TraductorIcon from "@/assets/traductor.svg";

// Only allow a background class; fall back to the default palette if not provided
const bubbleBgClass = (Astro.props.customStyle?.startsWith("bg-") ? Astro.props.customStyle : "bg-salmon") as string;
const label = Astro.props.label;
---

<div class="relative inline-block">
  <button id="btnTraductor" aria-label={label}>
    <TraductorIcon />
  </button>
  <div
    id="bocadilloTraductor"
    class={`min-h-fit w-32 absolute text-sm rounded-lg shadow-lg text-white hidden z-50 font-jomolhari font-normal py-3 px-2 backdrop-blur-sm right-[-15px] top-12 ${bubbleBgClass}`}
  >
    <div
      id="trianguloTraductor"
      aria-hidden="true"
      class={`absolute -top-1 right-6 w-3 h-3 rotate-45 z-60 ${bubbleBgClass}`}
    >
    </div>
    <ul class="w-full space-y-2">
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="ar" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡¸ðŸ‡¦</span>
          <span class="font-medium">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
        </a>
      </li>
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="de" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡©ðŸ‡ª</span>
          <span class="font-medium">Deutsch</span>
        </a>
      </li>
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="en" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡¬ðŸ‡§</span>
          <span class="font-medium">English</span>
        </a>
      </li>
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="es" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡ªðŸ‡¸</span>
          <span class="font-medium">EspaÃ±ol</span>
        </a>
      </li>
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="fr" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡«ðŸ‡·</span>
          <span class="font-medium">FranÃ§ais</span>
        </a>
      </li>
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="it" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡®ðŸ‡¹</span>
          <span class="font-medium">Italiano</span>
        </a>
      </li>
      <li class="transition-all duration-200 hover:bg-white/10 rounded-md">
        <a href="#" data-lang="pt" class="flex items-center gap-3 px-4 hover:text-red transition-colors duration-200">
          <span class="text-lg">ðŸ‡µðŸ‡¹</span>
          <span class="font-medium">PortuguÃªs</span>
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  import { Languages } from "@/enums/enums";
  import { writeLangCookie } from "@/utils/cookie";

  // Espera a que el DOM estÃ© completamente cargado
  document.addEventListener("DOMContentLoaded", function () {
    const btnTraductor = document.getElementById("btnTraductor");
    const bocadilloTraductor = document.getElementById("bocadilloTraductor");
    if (btnTraductor && bocadilloTraductor) {
      // Manejar clic en el botÃ³n del traductor
      btnTraductor.addEventListener("click", function (e) {
        e.stopPropagation();
        bocadilloTraductor.classList.toggle("hidden");
      });

      // Manejar clics en los enlaces de idioma
      bocadilloTraductor.addEventListener("click", function (e) {
        const target = e.target as HTMLElement;
        // Buscar el elemento <a> mÃ¡s cercano (puede ser el target o un ancestro)
        const link = target.closest("a[data-lang]");

        if (link) {
          e.preventDefault();
          const lang = link.getAttribute("data-lang") as Languages;

          if (!lang) return;

          const currentPath = globalThis.location.pathname;

          // Remover el prefijo de idioma actual si existe
          const pathWithoutLang = currentPath.replace(/^\/(ar|de|en|es|fr|it|pt)(\/|$)/, "/");

          // Construir nueva URL
          let newPath = lang === Languages.SPANISH ? pathWithoutLang || "/" : `/${lang}${pathWithoutLang || "/"}`;
          // Limpiar dobles barras
          newPath = newPath.replace(/\/+/g, "/");

          // Escribir la cookie de idioma usando la funciÃ³n centralizada
          writeLangCookie(lang);
          globalThis.location.href = newPath;
        }
      });
    }

    // Cerrar el menÃº si se hace clic fuera de Ã©l
    document.addEventListener("click", function (e) {
      if (
        bocadilloTraductor &&
        btnTraductor &&
        !bocadilloTraductor.classList.contains("hidden") &&
        !btnTraductor.contains(e.target as Node) &&
        !bocadilloTraductor.contains(e.target as Node)
      ) {
        bocadilloTraductor.classList.add("hidden");
      }
    });
  });
</script>
